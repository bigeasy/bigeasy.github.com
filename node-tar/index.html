
<!DOCTYPE html>
<html>
<head>
  <title>Node Tar</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="site/idl.css">
</head>
<body>
  
  <a href="http://github.com/bigeasy/node-tar"><img style="position: fixed; top: 0; right:
  0; border: 0;" src="http://s3.amazonaws.com/github/ribbons/forkme_right_orange_ff7600.png"
  alt="Fork me on GitHub" /></a>
  
  <div id="container">
    <div id="narrative">
      
        
        
        
          <h1>Node Tar</h1>

<p>Evented reading and writing of tar format archives.</p>
        
      
        
        
        
          <h2>Synopsis</h2>

<p>The <code>Parser</code> class is a <code>WritableStream</code>. It emits <code>"entry"</code> events that provide
the tar entry header and a <code>ReadableStream</code> of the <code>"entry"</code> contents.</p>

<p>The <code>Parser</code> is an incremental parser. It emits <code>"entry"</code> events the moment the
headers are read from the stream and begins to stream contents immediately.</p>
        
          <div class="highlight"><pre><span class="kd">var</span> <span class="nx">tar</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;tar&quot;</span><span class="p">),</span>
    <span class="nx">fs</span>  <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;fs&quot;</span><span class="p">);</span>

<span class="cm">/* Pluck a file from a tarball and write to stdout. */</span>
<span class="kd">function</span> <span class="nx">cat</span><span class="p">(</span><span class="nx">tarfile</span><span class="p">,</span> <span class="nx">filename</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">tar</span><span class="p">.</span><span class="nx">Parser</span><span class="p">();</span>
  <span class="nx">reader</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;entry&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">header</span><span class="p">,</span> <span class="nx">stream</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">filename</span> <span class="o">==</span> <span class="nx">header</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">stream</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">stdout</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">});</span>
  <span class="nx">readable</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">createReadStream</span><span class="p">(</span><span class="nx">tarfile</span><span class="p">);</span>
  <span class="nx">readable</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">reader</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">cat</span><span class="p">(</span><span class="s2">&quot;hello.tar&quot;</span><span class="p">,</span> <span class="s2">&quot;hello/hello.txt&quot;</span><span class="p">);</span>
</pre></div>

        
          <p>The 'Serializer<code>class is a</code>ReadableStream<code>. You create entires by calling the
</code>entry<code>method and providing a header definition. The</code>entry<code>method returns a
</code>WritableStream`.</p>
        
          <div class="highlight"><pre><span class="kd">var</span> <span class="nx">tar</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;tar&quot;</span><span class="p">),</span>
    <span class="nx">fs</span>  <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;fs&quot;</span><span class="p">);</span>

<span class="cm">/* Write the files to the tar serializer. */</span>
<span class="kd">function</span> <span class="nx">store</span><span class="p">(</span><span class="nx">serializer</span><span class="p">,</span> <span class="nx">files</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">files</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">file</span> <span class="o">=</span> <span class="nx">files</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
    <span class="nx">source</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">createReadStream</span><span class="p">(</span><span class="nx">file</span><span class="p">);</span> 
    <span class="nx">source</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">serializer</span><span class="p">.</span><span class="nx">entry</span><span class="p">({</span> <span class="nx">name</span><span class="o">:</span> <span class="nx">file</span> <span class="p">}));</span>
    <span class="nx">source</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;end&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="nx">store</span><span class="p">(</span><span class="nx">serializer</span><span class="p">,</span> <span class="nx">file</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">serializer</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">serializer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">tar</span><span class="p">.</span><span class="nx">Serializer</span><span class="p">();</span>
<span class="nx">serializer</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">fs</span><span class="p">.</span><span class="nx">createWriteStream</span><span class="p">(</span><span class="nx">tarfile</span><span class="p">));</span>
<span class="nx">store</span><span class="p">(</span><span class="nx">serializer</span><span class="p">,</span> <span class="p">[</span> <span class="s2">&quot;README&quot;</span><span class="p">,</span> <span class="s2">&quot;LICENSE&quot;</span><span class="p">,</span> <span class="s2">&quot;hello_world.c&quot;</span> <span class="p">]);</span>
</pre></div>

        
          
        
      
        
        
        
          <h2>Objectives</h2>

<p>Create an incremental tar file parser with a streaming interface supporting as
many tar file formats as I can get my hands on. (Please submit a tar file
generated by your flavor or UNIX for testing.)</p>

<p>The <code>node-tar</code> parser and serializer are idomatic Node.js <code>EventEmitter</code>
classes. The library is remarkable for the following traits.</p>

<ul>
<li><strong>Incremental parser</strong> &ndash; The incremental parser emits <code>"entry"</code> events
the moment the headers are completed and begins to stream contents immediately.</li>
<li><strong>Streamable parser</strong> &ndash; The <code>Parser</code> implements <code>WritableStream</code> so you
can pipe a <code>ReadableStream</code> into it for parsing.</li>
<li><strong>Streamable parsed entries</strong> &ndash; Each <code>"entry"</code> event presents the
contents of the entry as a <code>WriteableStream</code> so you can pipe it to a
<code>WritableStream</code> destination.</li>
<li><strong>Streamable serializer</strong> &ndash; The <code>Serializer</code> implements
<code>ReadableStream</code> so you can pipe its output to a <code>WritableStream</code>
destination.</li>
<li><strong>Streamable serialized entries</strong> &ndash; The <code>Serializer</code> entries implement
<code>WriteableStream</code> so you can pipe entry content into the output archive.</li>
</ul>

<p>The <code>node-tar</code> library aims to support idomatic Node.js programming.</p>
        
      
        
          <h3 class="namespace">tar</h3>
        
        
        
          <p>Node Tar exports the parser and serializer classes in its exports.</p>
        
          <div class="highlight"><pre><span class="kd">var</span> <span class="nx">tar</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;tar&quot;</span><span class="p">);</span>
</pre></div>

        
          
        
      
        
          <h3 class="class">tar.Parser()</h3>
        
        
            
        
        
          <p>The <code>Parser</code> class consumes buffers and emits <code>"entry"</code> events. An <code>"entry"</code>
event provides the entry header and a <code>ReadableStream</code> that serves the contents.</p>

<p><code>Parser</code> is a <code>WritableStream</code> so you can pipe a <code>ReadableStream</code> into as shown
in the <a href="#Synopis">Synopsis</a>, or you can feed it buffers directly.</p>

<p>Below is the example from the sysopsis where the entry stream is processed by
user supplied event handlers.</p>
        
          <div class="highlight"><pre><span class="kd">var</span> <span class="nx">tar</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;tar&quot;</span><span class="p">),</span>
    <span class="nx">fs</span>  <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;fs&quot;</span><span class="p">);</span>

<span class="cm">/* Pluck a file from a tarball and write to stdout. */</span>
<span class="kd">function</span> <span class="nx">cat</span><span class="p">(</span><span class="nx">tarfile</span><span class="p">,</span> <span class="nx">filename</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">parser</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">tar</span><span class="p">.</span><span class="nx">Parser</span><span class="p">();</span>
  <span class="nx">parser</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;entry&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">header</span><span class="p">,</span> <span class="nx">stream</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">filename</span> <span class="o">==</span> <span class="nx">header</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">stream</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">stdout</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">});</span>
  <span class="nx">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="nx">readable</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">createReadStream</span><span class="p">(</span><span class="nx">tarfile</span><span class="p">);</span>
  <span class="cm">/* Handle the `ReadableStream` events ourselves. */</span>
  <span class="nx">readable</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">buffer</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">count</span> <span class="o">+=</span> <span class="nx">buffer</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> 
    <span class="nx">parser</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">buffer</span><span class="p">);</span>
  <span class="p">});</span>
  <span class="nx">readable</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;end&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">process</span><span class="p">.</span><span class="nx">stderr</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s2">&quot;The tar file was #{count} bytes long.&quot;</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">}</span>

<span class="nx">cat</span><span class="p">(</span><span class="s2">&quot;hello.tar&quot;</span><span class="p">,</span> <span class="s2">&quot;hello/hello.txt&quot;</span><span class="p">);</span>
</pre></div>

        
          <p><code>Parser</code> implements all of the functions and events of  the <code>WritableStream</code>
interface. The <code>WritablStream</code> interface is a staple of Node.js programming, so
a description of how they work will not be repeated here.  Refer to the
<a href="http://nodejs.org/docs/v0.4.6/api/streams.html#writable_Stream"><code>WritableStream</code></a>
documentation for details of <code>WritableStream</code> usage.</p>
        
      
        
          <h3 class="event">on("entry", function (header, stream) {})</h3>
        
        
            
                <div class="parameter">
                  <h4>header</h4>
                  
                    <p>The fields of the tar entry header.</p>
                  
                </div>
            
                <div class="parameter">
                  <h4>stream</h4>
                  
                    <p>A readable stream of the tar entry contents</p>
                  
                </div>
            
        
        
          <p>An object containing the tar header. <strong>Show the fields.</strong></p>

<p>Emitted when after a header is encontered in the tar acrhive an prior to
streaming the file contents.</p>

<p>The <code>header</code> is an object containing the header as name value pairs.</p>

<p>The <code>stream</code> is a <code>ReadableStream</code> that provides the entry contents. You can
pipe the stream to a <code>WritableStream</code> destination, or you can handle the stream
events direction.</p>

<p>Below is the example from the sysopsis where the entry stream is processed by
user supplied event handlers.</p>
        
          <div class="highlight"><pre><span class="kd">var</span> <span class="nx">tar</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;tar&quot;</span><span class="p">),</span>
    <span class="nx">fs</span>  <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;fs&quot;</span><span class="p">);</span>

<span class="cm">/* Pluck a file from a tarball and write to stdout. */</span>
<span class="kd">function</span> <span class="nx">cat</span><span class="p">(</span><span class="nx">tarfile</span><span class="p">,</span> <span class="nx">filename</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">tar</span><span class="p">.</span><span class="nx">Parser</span><span class="p">();</span>
  <span class="nx">reader</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;entry&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">header</span><span class="p">,</span> <span class="nx">stream</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">filename</span> <span class="o">==</span> <span class="nx">header</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="nx">stream</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">chunk</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">count</span> <span class="o">+=</span> <span class="nx">chunk</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
        <span class="nx">process</span><span class="p">.</span><span class="nx">stdout</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">chunk</span><span class="p">);</span>
      <span class="p">});</span>
      <span class="nx">stream</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;end&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">process</span><span class="p">.</span><span class="nx">stderr</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span> 
          <span class="s2">&quot;Streamed &quot;</span> <span class="o">+</span> <span class="nx">count</span> <span class="o">+</span> <span class="s2">&quot; byte(s) of entry &quot;</span> <span class="o">+</span> <span class="nx">filename</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span>
        <span class="p">);</span>
      <span class="p">});</span>
    <span class="p">}</span>
  <span class="p">});</span>
  <span class="nx">readable</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">createReadStream</span><span class="p">(</span><span class="nx">tarfile</span><span class="p">);</span>
  <span class="nx">readable</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">reader</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">cat</span><span class="p">(</span><span class="s2">&quot;hello.tar&quot;</span><span class="p">,</span> <span class="s2">&quot;hello/hello.txt&quot;</span><span class="p">);</span>
</pre></div>

        
          <p>The stream provided by the <code>"entry"</code> event implements all the functions and
events of the <code>ReadableStream</code> interface. The <code>ReadableStream</code> interface is a
staple of Node.js programming, so a description of how they work will not be
repeated here.  Refer to the
<a href="http://nodejs.org/docs/v0.4.6/api/streams.html#readable_Stream"><code>ReadableStream</code></a>
documentation for details of <code>ReadableStream</code> usage.</p>
        
      
        
          <h3 class="event">on("end", function () {})</h3>
        
        
            
        
        
          <p>Called when the end of the tar archive is reached.</p>
        
      
        
          <h3 class="class">tar.Serializer()</h3>
        
        
            
        
        
          <p>The <code>Serializer</code> is essentially a <code>WritableStream</code> factory, creating
<code>WritableStream</code> instances used to write tar file entires.</p>
        
      
        
          
            <h3 class="function">entry(filename)</h3>
          
        
        
            
                <div class="parameter">
                  <h4>filename</h4>
                  
                    <p>A file to stream into the tar file.</p>
                  
                </div>
            
        
        
          <p>Returns a <code>WritableStream</code> used to write the given filename. The header
properties are read by stating the file. </p>
        
      
        
          
            <h3 class="function">entry(filename, callback)</h3>
          
        
        
            
                <div class="parameter">
                  <h4>filename</h4>
                  
                    <p>A file to stream into the tar file.</p>
                  
                </div>
            
                <div class="parameter">
                  <h4>callback</h4>
                  
                    <p>Invoked when the file is written.</p>
                  
                </div>
            
        
        
          <p>Writes the given file into the tar archive and invokes the callback when
completed.</p>
        
      
        
          
            <h3 class="function">entry(filename, header)</h3>
          
        
        
            
                <div class="parameter">
                  <h4>filename</h4>
                  
                    <p>A file name for the tar entry.</p>
                  
                </div>
            
                <div class="parameter">
                  <h4>header</h4>
                  
                    <p>Header properties for the tar entry.</p>
                  
                </div>
            
        
        
          <p>Creates <code>WritableStream</code> used to write contents into an entry with the given
<code>filename</code>. The header properties are used to create the entry. The <code>size</code> must
be provided and it must reflect the actual bytes written to the stream.</p>
        
      
    </div>
    <div id="api">
      
        
      
        
          <h2 class="heading">Synopsis</h3>
        
      
        
          <h2 class="heading">Objectives</h3>
        
      
        
          <h3 class="namespace depth-0">tar</h3>
        
      
        
          <h3 class="class depth-1">Parser</h3>
        
      
        
          <h3 class="function depth-2">"entry"</h3>
        
      
        
          <h3 class="function depth-2">"end"</h3>
        
      
        
          <h3 class="class depth-1">Serializer</h3>
        
      
        
          <h3 class="function depth-2">entry</h3>
        
      
        
          <h3 class="function depth-2">entry</h3>
        
      
        
          <h3 class="function depth-2">entry</h3>
        
      
      
        <h2 class="heading">Docco</h3>
        
          
        
          
            
            <h3 class="docco depth-0"><a href="./documentation/tar.html">tar.coffee</a></h3>
          
        
      
    </div>
  </div>
</body>
</html>
