<!DOCTYPE html>  <html> <head>   <title>idl.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               idl.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-1">#</a>               </div>               <p>Require Node.js core modules.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">fs            = </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;fs&quot;</span><span class="p">)</span>
<span class="nv">sys           = </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;sys&quot;</span><span class="p">)</span>
<span class="nv">showdown      = </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;./../vendor/docco/vendor/showdown&quot;</span><span class="p">).</span><span class="nx">Showdown</span>
<span class="nv">fred          = </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;path&quot;</span><span class="p">)</span>
<span class="p">{</span><span class="nx">spawn</span><span class="p">,</span> <span class="nx">exec</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span> <span class="s1">&#39;child_process&#39;</span>

<span class="nv">github = </span><span class="nf">(callback) -&gt;</span>
  <span class="nv">remotes = </span>       <span class="s2">&quot;&quot;</span>
  <span class="nv">git = </span>            <span class="nx">spawn</span> <span class="s2">&quot;git&quot;</span><span class="p">,</span> <span class="p">[</span> <span class="s2">&quot;remote&quot;</span><span class="p">,</span> <span class="s2">&quot;-v&quot;</span> <span class="p">]</span>
  <span class="nx">git</span><span class="p">.</span><span class="nx">stdout</span><span class="p">.</span><span class="kc">on</span>     <span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="nf">(buffer) -&gt;</span> <span class="nx">remotes</span> <span class="o">+=</span> <span class="nx">buffer</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>
  <span class="nx">git</span><span class="p">.</span><span class="nx">stderr</span><span class="p">.</span><span class="kc">on</span>     <span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="nf">(buffer) -&gt;</span> <span class="nx">puts</span> <span class="nx">buffer</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>
  <span class="nx">git</span><span class="p">.</span><span class="kc">on</span>            <span class="s2">&quot;exit&quot;</span><span class="p">,</span> <span class="nf">(status) -&gt;</span>
    <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="nx">status</span> <span class="o">!=</span> <span class="mi">0</span>
    <span class="nv">remote = </span><span class="sr">/\s+git@github.com:(.*\/.*).git\s+/</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">remotes</span><span class="p">)</span>
    <span class="nx">callback</span><span class="p">(</span><span class="nx">remote</span> <span class="o">and</span> <span class="nx">remote</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-2">#</a>               </div>               <p>Generate the source by creating a IDL object model to define the project, then
passing the IDL object model to the templating engine.</p>

<p>The method will create a default <code>./site/idl.css</code> if none exists.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">generate = </span><span class="nf">(source, destination) -&gt;</span>
  <span class="k">try</span>
    <span class="nv">docco = </span><span class="nx">fs</span><span class="p">.</span><span class="nx">readdirSync</span><span class="p">(</span><span class="s2">&quot;./documentation&quot;</span><span class="p">)</span>
  <span class="k">catch</span> <span class="nx">e</span>
    <span class="k">throw</span> <span class="nx">e</span> <span class="k">if</span> <span class="nx">e</span><span class="p">.</span><span class="nx">errno</span> <span class="o">isnt</span> <span class="mi">2</span>
  <span class="nx">github</span> <span class="nf">(remote) -&gt;</span>
    <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span> <span class="nx">source</span><span class="p">,</span> <span class="s2">&quot;utf8&quot;</span><span class="p">,</span> <span class="nf">(error, code) -&gt;</span>
      <span class="nv">structure = </span><span class="nx">parse</span> <span class="nx">source</span><span class="p">,</span> <span class="nx">code</span>
      <span class="nv">structure.github = </span><span class="nx">remote</span>
      <span class="nv">structure.docco = </span><span class="nx">docco</span>
      <span class="k">try</span>
        <span class="nx">fs</span><span class="p">.</span><span class="nx">mkdirSync</span><span class="p">(</span><span class="s2">&quot;./site&quot;</span><span class="p">,</span> <span class="mi">755</span><span class="p">)</span>
      <span class="k">catch</span> <span class="nx">e</span>
        <span class="k">throw</span> <span class="nx">e</span> <span class="k">if</span> <span class="nx">e</span><span class="p">.</span><span class="nx">errno</span> <span class="o">isnt</span> <span class="mi">17</span>
      <span class="k">try</span>
        <span class="nx">fs</span><span class="p">.</span><span class="nx">statSync</span> <span class="s2">&quot;./site/idl.css&quot;</span>
      <span class="k">catch</span> <span class="nx">e</span>
        <span class="k">throw</span> <span class="nx">e</span> <span class="k">if</span> <span class="nx">e</span><span class="p">.</span><span class="nx">errno</span> <span class="o">isnt</span> <span class="mi">2</span>
        <span class="nv">css = </span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span> <span class="s2">&quot;#{__dirname}/../site/idl.css&quot;</span><span class="p">,</span> <span class="s2">&quot;utf8&quot;</span>
        <span class="nx">fs</span><span class="p">.</span><span class="nx">writeFileSync</span> <span class="s2">&quot;./site/idl.css&quot;</span><span class="p">,</span> <span class="nx">css</span><span class="p">,</span> <span class="s2">&quot;utf8&quot;</span>
      <span class="nx">munge</span> <span class="nx">structure</span><span class="p">.</span><span class="nx">sections</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="o">-&gt;</span>
        <span class="nv">ejs = </span><span class="s2">&quot;./site/idl.ejs&quot;</span>
        <span class="k">try</span>
          <span class="nx">fs</span><span class="p">.</span><span class="nx">statSync</span> <span class="nx">ejs</span>
        <span class="k">catch</span> <span class="nx">_</span>
          <span class="nv">ejs = </span><span class="s2">&quot;#{__dirname}/../site/idl.ejs&quot;</span>
        <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span> <span class="nx">ejs</span><span class="p">,</span> <span class="s2">&quot;utf8&quot;</span><span class="p">,</span> <span class="nf">(error, code) -&gt;</span>
          <span class="k">throw</span> <span class="nx">error</span> <span class="k">if</span> <span class="nx">error</span>
          <span class="nv">html = </span><span class="nx">template</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span> <span class="nx">structure</span>
          <span class="nx">fs</span><span class="p">.</span><span class="nx">writeFileSync</span><span class="p">(</span><span class="nx">destination</span><span class="p">,</span> <span class="nx">html</span><span class="p">)</span>
      <span class="kc">true</span>
    <span class="kc">true</span>
  <span class="kc">true</span>

<span class="k">class</span> <span class="nx">Section</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-3">#</a>               </div>               <p>Construct a member and link it into its parent.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">constructor: </span><span class="nf">(@parent, @name, @type) -&gt;</span>
    <span class="vi">@members    = </span><span class="p">{}</span>
    <span class="vi">@parameters = </span><span class="p">[]</span>
    <span class="vi">@blocks     = </span><span class="p">[</span> <span class="p">[]</span> <span class="p">]</span>
    <span class="vi">@html       = </span><span class="p">[]</span>
    <span class="nx">@parent</span><span class="p">.</span><span class="nx">members</span><span class="p">[</span><span class="nx">@name</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span> <span class="k">if</span> <span class="nx">@parent</span>

  <span class="nv">addBlock: </span><span class="o">-&gt;</span>
    <span class="nx">@blocks</span><span class="p">.</span><span class="nx">push</span><span class="p">([])</span>

  <span class="nv">pushLine: </span><span class="nf">(line) -&gt;</span>
    <span class="nx">@blocks</span><span class="p">[</span><span class="nx">@blocks</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span>

  <span class="nv">depth: </span><span class="o">-&gt;</span>
    <span class="nv">depth = </span><span class="mi">0</span>
    <span class="nv">parent = </span><span class="nx">@parent</span>
    <span class="k">while</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">parent</span>
      <span class="nx">depth</span><span class="o">++</span>
      <span class="nv">parent = </span><span class="nx">parent</span><span class="p">.</span><span class="nx">parent</span>
    <span class="nx">depth</span>

  <span class="nv">shortName: </span><span class="o">-&gt;</span>
    <span class="nv">name = </span><span class="nx">@name</span>
    <span class="k">if</span> <span class="nx">@type</span> <span class="o">is</span> <span class="s2">&quot;function&quot;</span>
      <span class="nv">params = </span><span class="p">[]</span>
      <span class="nv">separator = </span><span class="s2">&quot;&quot;</span>
      <span class="k">for</span> <span class="nx">parameter</span> <span class="k">in</span> <span class="nx">@parameters</span>
        <span class="k">if</span> <span class="nx">parameter</span><span class="p">.</span><span class="nx">optional</span>
          <span class="nx">params</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&quot;[#{separator + parameter.name}]&quot;</span><span class="p">)</span>
        <span class="k">else</span>
          <span class="nx">params</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">separator</span> <span class="o">+</span> <span class="nx">parameter</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span>
        <span class="nv">separator = </span><span class="s2">&quot;, &quot;</span>
      <span class="nx">name</span> <span class="o">+=</span> <span class="s2">&quot;(#{params.join(&quot;&quot;)})&quot;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">@type</span> <span class="o">is</span> <span class="s2">&quot;event&quot;</span>
      <span class="nv">params = </span><span class="p">[]</span>
      <span class="nv">separator = </span><span class="s2">&quot;&quot;</span>
      <span class="k">for</span> <span class="nx">parameter</span> <span class="k">in</span> <span class="nx">@parameters</span>
        <span class="k">if</span> <span class="nx">parameter</span><span class="p">.</span><span class="nx">optional</span>
          <span class="nx">params</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&quot;[#{separator + parameter.name}]&quot;</span><span class="p">)</span>
        <span class="k">else</span>
          <span class="nx">params</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">separator</span> <span class="o">+</span> <span class="nx">parameter</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span>
        <span class="nv">separator = </span><span class="s2">&quot;, &quot;</span>
      <span class="nv">name = </span><span class="s2">&quot;on(\&quot;#{name}\&quot;, function (#{params.join(&quot;&quot;)}) {})&quot;</span>
    <span class="nx">name</span>

  <span class="nv">fullName: </span><span class="o">-&gt;</span>
    <span class="nv">path = </span><span class="p">[</span> <span class="nx">@shortName</span><span class="p">()</span> <span class="p">]</span>
    <span class="nv">parent = </span><span class="nx">@parent</span>
    <span class="k">while</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">parent</span>
      <span class="nx">path</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">parent</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span>
      <span class="nv">parent = </span><span class="nx">parent</span><span class="p">.</span><span class="nx">parent</span>
    <span class="nx">path</span><span class="p">.</span><span class="nx">reverse</span><span class="p">()</span>
    <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>

<span class="nv">parse = </span><span class="nf">(source, code) -&gt;</span>
  <span class="nv">lines     = </span><span class="nx">code</span><span class="p">.</span><span class="nx">split</span> <span class="s2">&quot;\n&quot;</span>
  <span class="nv">indent    = </span><span class="o">-</span><span class="mi">1</span>
  <span class="nv">section   = </span><span class="k">new</span> <span class="nx">Section</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="s2">&quot;narrative&quot;</span>
  <span class="nv">sections  = </span><span class="p">[</span> <span class="nx">section</span> <span class="p">]</span>
  <span class="nv">structure = </span><span class="p">{</span> <span class="nv">sections: </span><span class="nx">sections</span> <span class="p">}</span>
  <span class="nv">mode      = </span><span class="s2">&quot;text&quot;</span>
  <span class="nv">type      = </span><span class="kc">null</span>
  <span class="nv">procedure = </span><span class="kc">null</span>

  <span class="k">for</span> <span class="nx">line</span> <span class="k">in</span> <span class="nx">lines</span>
    <span class="nv">code      = </span><span class="sr">/^\s*```(\S*)\s*$/</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">mode</span> <span class="o">is</span> <span class="s2">&quot;text&quot;</span>
      <span class="nv">title     = </span><span class="sr">/^\s*#\s+(.*?)\s*$/</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span>
      <span class="nv">heading   = </span><span class="sr">/^\s*##\s+(.*?)\s*$/</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span>

      <span class="nv">spaces    = </span><span class="sr">/^(\s*)/</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">line</span><span class="p">)[</span><span class="mi">1</span><span class="p">].</span><span class="nx">length</span>
      <span class="nv">directive = </span><span class="sr">/^\s*(namespace|class|event|function|parameter|factory|return):\s*(.*?)\s*$/</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span>

      <span class="nx">structure</span><span class="p">.</span><span class="nx">title</span> <span class="o">or=</span> <span class="nx">title</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nx">title</span>


      <span class="k">if</span> <span class="nx">code</span>
        <span class="nx">section</span><span class="p">.</span><span class="nx">addBlock</span><span class="p">()</span>
        <span class="nx">section</span><span class="p">.</span><span class="nx">pushLine</span> <span class="nx">code</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="nv">mode = </span><span class="s2">&quot;code&quot;</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nx">heading</span>
        <span class="nv">section = </span><span class="k">new</span> <span class="nx">Section</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">heading</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;narrative&quot;</span>
        <span class="nx">section</span><span class="p">.</span><span class="nx">pushLine</span> <span class="nx">line</span>
        <span class="nx">sections</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">section</span><span class="p">)</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nx">directive</span>
        <span class="p">[</span><span class="nx">directive</span><span class="p">,</span> <span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nx">directive</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">directive</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
        <span class="k">if</span> <span class="nx">directive</span> <span class="o">==</span> <span class="s2">&quot;namespace&quot;</span>
          <span class="nv">type        = </span><span class="kc">null</span>
          <span class="nv">procedure   = </span><span class="kc">null</span>
          <span class="nv">path        = </span><span class="nx">name</span><span class="p">.</span><span class="nx">split</span> <span class="sr">/\./</span>
          <span class="nv">namespace   = </span><span class="nx">section</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-4">#</a>               </div>               <p>Rewind to the parent narrative section.</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="k">while</span> <span class="nx">section</span><span class="p">.</span><span class="nx">parent</span>
            <span class="nv">section     = </span><span class="nx">section</span><span class="p">.</span><span class="nx">parent</span>

          <span class="k">for</span> <span class="nx">part</span><span class="p">,</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">path</span>
            <span class="k">new</span> <span class="nx">Section</span> <span class="nx">namespace</span><span class="p">,</span> <span class="nx">part</span><span class="p">,</span> <span class="s2">&quot;namespace&quot;</span>
            <span class="nv">namespace = </span><span class="nx">namespace</span><span class="p">.</span><span class="nx">members</span><span class="p">[</span><span class="nx">part</span><span class="p">]</span>

          <span class="nv">section = </span><span class="nx">namespace</span>
          <span class="nx">sections</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">section</span><span class="p">)</span>
        <span class="k">else</span> <span class="k">if</span> <span class="nx">directive</span> <span class="o">==</span> <span class="s2">&quot;class&quot;</span>
          <span class="nv">procedure   = </span><span class="kc">null</span>
          <span class="nv">type        = </span><span class="nx">namespace</span>
          <span class="nv">path        = </span><span class="nx">name</span><span class="p">.</span><span class="nx">split</span> <span class="sr">/\./</span>
          <span class="k">for</span> <span class="nx">part</span><span class="p">,</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">path</span>
             <span class="k">new</span> <span class="nx">Section</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">part</span><span class="p">,</span> <span class="s2">&quot;class&quot;</span>
            <span class="nv">type = </span><span class="nx">type</span><span class="p">.</span><span class="nx">members</span><span class="p">[</span><span class="nx">part</span><span class="p">]</span>
          <span class="nv">section = </span><span class="nx">type</span>
          <span class="nx">sections</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">section</span><span class="p">)</span>
        <span class="k">else</span> <span class="k">if</span> <span class="nx">directive</span> <span class="o">==</span> <span class="s2">&quot;function&quot;</span>
          <span class="nv">procedure = section = </span><span class="k">new</span> <span class="nx">Section</span> <span class="nx">type</span> <span class="o">or</span> <span class="nx">namespace</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="s2">&quot;function&quot;</span>
          <span class="nx">sections</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">section</span><span class="p">)</span>
        <span class="k">else</span> <span class="k">if</span> <span class="nx">directive</span> <span class="o">==</span> <span class="s2">&quot;event&quot;</span>
          <span class="nv">procedure = section = </span><span class="k">new</span> <span class="nx">Section</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="s2">&quot;event&quot;</span>
          <span class="nx">sections</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">section</span><span class="p">)</span>
        <span class="k">else</span> <span class="k">if</span> <span class="nx">directive</span> <span class="o">==</span> <span class="s2">&quot;parameter&quot;</span>
          <span class="nv">properties = </span><span class="nx">name</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="sr">/\s+/</span><span class="p">)</span>
          <span class="nv">name = </span><span class="nx">properties</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span>
          <span class="nv">parameter = section = </span><span class="k">new</span> <span class="nx">Section</span> <span class="nx">procedure</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="s2">&quot;paremeter&quot;</span>
          <span class="k">for</span> <span class="nx">property</span> <span class="k">in</span> <span class="nx">properties</span>
            <span class="nx">parameter</span><span class="p">[</span><span class="nx">property</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span>
          <span class="nx">procedure</span><span class="p">.</span><span class="nx">parameters</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">parameter</span><span class="p">)</span>
          <span class="nv">indent = </span><span class="nx">spaces</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nx">spaces</span> <span class="o">&lt;</span> <span class="nx">indent</span> <span class="o">and</span> <span class="sr">/\S/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span>
        <span class="nv">section = </span><span class="nx">procedure</span> <span class="o">||</span> <span class="nx">type</span>
        <span class="nx">section</span><span class="p">.</span><span class="nx">pushLine</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="nx">section</span><span class="p">.</span><span class="nx">pushLine</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">code</span>
      <span class="nv">mode = </span><span class="s2">&quot;text&quot;</span>
      <span class="nx">section</span><span class="p">.</span><span class="nx">addBlock</span><span class="p">()</span>
    <span class="k">else</span>
      <span class="nx">section</span><span class="p">.</span><span class="nx">pushLine</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span>

  <span class="nx">structure</span>

<span class="nv">munge = </span><span class="nf">(sections, callback) -&gt;</span>
  <span class="nv">text = </span><span class="kc">true</span>
  <span class="nv">next = </span><span class="o">-&gt;</span> <span class="nx">munge</span> <span class="nx">sections</span><span class="p">,</span> <span class="nx">callback</span>
  <span class="k">if</span> <span class="nx">sections</span><span class="p">.</span><span class="nx">length</span>
    <span class="nv">parameters = </span><span class="nx">p</span> <span class="k">for</span> <span class="nx">p</span> <span class="k">in</span> <span class="nx">sections</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">parameters</span> <span class="k">when</span> <span class="nx">p</span><span class="p">.</span><span class="nx">blocks</span><span class="p">.</span><span class="nx">length</span>
    <span class="k">if</span> <span class="nx">parameters</span><span class="p">.</span><span class="nx">length</span>
      <span class="nx">munge</span> <span class="nx">parameters</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="nx">next</span>
    <span class="k">else</span>
      <span class="nv">section     = </span><span class="nx">sections</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="nv">exposition  = </span><span class="nx">section</span><span class="p">.</span><span class="nx">blocks</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span>
      <span class="nv">code        = </span><span class="nx">section</span><span class="p">.</span><span class="nx">blocks</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span>
      <span class="k">if</span> <span class="nx">exposition</span>
        <span class="nx">section</span><span class="p">.</span><span class="nx">html</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">showdown</span><span class="p">.</span><span class="nx">makeHtml</span> <span class="nx">exposition</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;\n&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="nx">code</span>
          <span class="nx">highlight</span> <span class="nx">section</span><span class="p">,</span> <span class="nx">code</span><span class="p">,</span> <span class="nx">next</span>
        <span class="k">else</span>
          <span class="nx">next</span><span class="p">()</span>
      <span class="k">else</span>
        <span class="nx">sections</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span>
        <span class="nx">next</span><span class="p">()</span>
  <span class="k">else</span>
    <span class="nx">callback</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-5">#</a>               </div>               <p>Micro-templating, originally by John Resig, borrowed by way of
<a href="http://documentcloud.github.com/underscore/">Underscore.js</a>.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">template = </span><span class="nf">(str) -&gt;</span>
  <span class="k">new</span> <span class="nb">Function</span> <span class="s1">&#39;obj&#39;</span><span class="p">,</span>
    <span class="s1">&#39;var p=[],print=function(){p.push.apply(p,arguments);};&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;with(obj){p.push(\&#39;&#39;</span> <span class="o">+</span>
    <span class="nx">str</span>  <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\r/g</span><span class="p">,</span> <span class="s1">&#39;\\r&#39;</span><span class="p">)</span>
         <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\n/g</span><span class="p">,</span> <span class="s1">&#39;\\n&#39;</span><span class="p">)</span>
         <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\t/g</span><span class="p">,</span> <span class="s1">&#39;\\t&#39;</span><span class="p">)</span>
         <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&#39;(?=[^%]*%&gt;)/g</span><span class="p">,</span><span class="s2">&quot;✄&quot;</span><span class="p">)</span>
         <span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;\\&#39;&quot;</span><span class="p">)</span>
         <span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;✄&quot;</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span>
         <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&lt;%=(.+?)%&gt;/g</span><span class="p">,</span> <span class="s2">&quot;&#39;,$1,&#39;&quot;</span><span class="p">)</span>
         <span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;&lt;%&quot;</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;&#39;);&quot;</span><span class="p">)</span>
         <span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;%&gt;&quot;</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;p.push(&#39;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39;);}return p.join(&#39;&#39;);&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-6">#</a>               </div>               <p>Highlights a single chunk of CoffeeScript code, using <strong>Pygments</strong> over stdio,
and runs the text of its corresponding comment through <strong>Markdown</strong>, using the
<strong>Github-flavored-Markdown</strong> modification of
<a href="http://attacklab.net/showdown/">Showdown.js</a>.</p>

<p>We process the entire file in a single call to Pygments by inserting little
marker comments between each section and then splitting the result string
wherever our markers occur.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">highlight = </span><span class="nf">(section, block, callback) -&gt;</span>
  <span class="nv">language = </span><span class="nx">block</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span>
  <span class="k">if</span> <span class="nx">language</span>
    <span class="nv">pygments = </span><span class="nx">spawn</span> <span class="s1">&#39;pygmentize&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;-l&#39;</span><span class="p">,</span> <span class="nx">language</span><span class="p">,</span> <span class="s1">&#39;-f&#39;</span><span class="p">,</span> <span class="s1">&#39;html&#39;</span><span class="p">,</span> <span class="s1">&#39;-O&#39;</span><span class="p">,</span> <span class="s1">&#39;encoding=utf-8&#39;</span><span class="p">]</span>
    <span class="nv">output   = </span><span class="s1">&#39;&#39;</span>
    <span class="nx">pygments</span><span class="p">.</span><span class="nx">stderr</span><span class="p">.</span><span class="nx">addListener</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span>  <span class="nf">(error)  -&gt;</span>
      <span class="nx">puts</span> <span class="nx">error</span> <span class="k">if</span> <span class="nx">error</span>
    <span class="nx">pygments</span><span class="p">.</span><span class="nx">stdout</span><span class="p">.</span><span class="nx">addListener</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="nf">(result) -&gt;</span>
      <span class="nx">output</span> <span class="o">+=</span> <span class="nx">result</span> <span class="k">if</span> <span class="nx">result</span>
    <span class="nx">pygments</span><span class="p">.</span><span class="nx">addListener</span> <span class="s1">&#39;exit&#39;</span><span class="p">,</span> <span class="o">-&gt;</span>
      <span class="nx">section</span><span class="p">.</span><span class="nx">html</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">output</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-7">#</a>               </div>               <p>output = output.replace(highlight<em>start, '').replace(highlight</em>end, '')
fragments = output.split language.divider<em>html
for section, i in sections
j.u  section.code</em>html = highlight<em>start + fragments[i] + highlight</em>end
 section.docs<em>html = showdown.makeHtml section.docs</em>text</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">callback</span><span class="p">()</span>
    <span class="nx">pygments</span><span class="p">.</span><span class="nx">stdin</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">block</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;\n&quot;</span><span class="p">))</span>
    <span class="nx">pygments</span><span class="p">.</span><span class="nx">stdin</span><span class="p">.</span><span class="nx">end</span><span class="p">()</span>
  <span class="k">else</span> <span class="k">if</span> <span class="nx">block</span><span class="p">.</span><span class="nx">length</span>
    <span class="nv">indent = </span><span class="nb">parseInt</span><span class="p">(</span><span class="sr">/^(\s*)/</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">block</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">10</span><span class="p">)</span>
    <span class="nv">block = </span><span class="k">for</span> <span class="nx">line</span> <span class="k">in</span> <span class="nx">block</span>
      <span class="nx">line</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">indent</span><span class="p">)</span>
    <span class="nv">block = </span><span class="nx">block</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;\n&quot;</span><span class="p">)</span>
    <span class="nv">block = </span><span class="nx">block</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&amp;/g</span><span class="p">,</span> <span class="s2">&quot;&amp;amp&quot;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&lt;/g</span><span class="p">,</span> <span class="s2">&quot;&amp;lt;&quot;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&gt;/g</span><span class="p">,</span> <span class="s2">&quot;&amp;gt;&quot;</span><span class="p">)</span>
    <span class="nx">section</span><span class="p">.</span><span class="nx">html</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&quot;&lt;div class=&#39;highlight&#39;&gt;&lt;pre&gt;&quot;</span> <span class="o">+</span> <span class="nx">block</span> <span class="o">+</span> <span class="s2">&quot;&lt;/pre&gt;&lt;/div&gt;&quot;</span><span class="p">)</span>
    <span class="nx">callback</span><span class="p">()</span>


<span class="nv">module.exports.generate = </span><span class="nx">generate</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 