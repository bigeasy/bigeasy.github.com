<!DOCTYPE html>  <html> <head>   <title>packet.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="argument.html">                 argument.coffee               </a>                                           <a class="source" href="packet.html">                 packet.coffee               </a>                                           <a class="source" href="pattern.html">                 pattern.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               packet.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="nv">parsePattern = </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;./pattern&quot;</span><span class="p">).</span><span class="nx">parse</span>
<span class="nv">ieee754 = </span><span class="nx">require</span> <span class="s2">&quot;./ieee754&quot;</span>
<span class="nv">stream = </span><span class="nx">require</span> <span class="s2">&quot;stream&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Convert an array of bytes into an hex string, two characters for each byte. #
FIXME Why less than 10 when we're doing hex?</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">hex = </span><span class="nf">(bytes) -&gt;</span>
  <span class="nv">h = </span><span class="nx">bytes</span><span class="p">.</span><span class="nx">map</span> <span class="nf">(b) -&gt;</span> <span class="k">if</span> <span class="nx">b</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="k">then</span> <span class="s2">&quot;0&quot;</span> <span class="o">+</span> <span class="nx">b</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="k">else</span> <span class="nx">b</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
  <span class="nx">h</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Default callback, when no callback is provided.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">noop = </span><span class="nf">(value) -&gt;</span> <span class="nx">value</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Base class for <code>Serializer</code> and <code>Parser</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Packet</span> <span class="k">extends</span> <span class="nx">stream</span><span class="p">.</span><span class="nx">Stream</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Construct a packet that sends events using the given <code>self</code> as <code>this</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">constructor: </span><span class="nf">(@self) -&gt;</span>
    <span class="vi">@_packets = </span><span class="p">{}</span>
    <span class="nx">@reset</span><span class="p">()</span>
    <span class="vi">@_fields = </span><span class="p">[]</span>
    <span class="vi">@transforms = </span><span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">transforms</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Create a copy that will adopt the packets defined in this object, through
prototype inheritence. This is used to efficently create parsers and
serializers that can run concurrently, from a pre-configured prototype,
following classic GoF prototype creational pattern.</p>

<p>FIXME Test me.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">clone: </span><span class="o">-&gt;</span>
    <span class="nv">copy            = </span><span class="k">new</span> <span class="p">(</span><span class="err">@</span><span class="p">.</span><span class="nx">constructor</span><span class="p">)()</span>
    <span class="nv">copy._packets   = </span><span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">@_packets</span><span class="p">)</span>
    <span class="nx">copy</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Map a named packet with the given <code>name</code> to the given <code>pattern</code>. </p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">packet: </span><span class="nf">(name, pattern, callback) -&gt;</span>
    <span class="nx">callback</span>      <span class="o">or=</span> <span class="nx">noop</span>
    <span class="nv">pattern         = </span><span class="nx">parsePattern</span><span class="p">(</span><span class="nx">pattern</span><span class="p">)</span>
    <span class="nx">@_packets</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="nx">pattern</span><span class="p">,</span> <span class="nx">callback</span><span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Resets the bytes read, bytes written and the current pattern. Used to
recover from exceptional conditions and generally a good idea to call this
method before starting a new series of packet parsing transitions.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">reset: </span><span class="o">-&gt;</span>
    <span class="vi">@bytesRead = </span><span class="mi">0</span>
    <span class="vi">@bytesWritten = </span><span class="mi">0</span>
    <span class="vi">@pattern = </span><span class="kc">null</span>
    <span class="vi">@callback = </span><span class="kc">null</span>
    <span class="vi">@_fields = </span><span class="p">[]</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Excute the pipeline of transforms for the <code>pattern</code> on the <code>value</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">pipeline: </span><span class="nf">(pattern, value) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Run the piplines for parsing.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">pattern</span><span class="p">.</span><span class="nx">transforms</span>
      <span class="k">for</span> <span class="nx">transform</span> <span class="k">in</span> <span class="nx">pattern</span><span class="p">.</span><span class="nx">transforms</span>
        <span class="nv">parameters = </span><span class="p">[]</span>
        <span class="k">for</span> <span class="nx">constant</span> <span class="k">in</span> <span class="nx">transform</span><span class="p">.</span><span class="nx">parameters</span>
          <span class="nx">parameters</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">constant</span><span class="p">)</span>
        <span class="nx">parameters</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="o">not</span> <span class="nx">@_outgoing</span><span class="p">)</span>
        <span class="nx">parameters</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">pattern</span><span class="p">)</span>
        <span class="nx">parameters</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span>
        <span class="nv">value = </span><span class="nx">@transforms</span><span class="p">[</span><span class="nx">transform</span><span class="p">.</span><span class="nx">name</span><span class="p">].</span><span class="nx">apply</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">parameters</span>
    <span class="nx">value</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Setup the next field in the current pattern to read or write.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">nextValue: </span><span class="nf">(value) -&gt;</span>
    <span class="nv">pattern     = </span><span class="nx">@pattern</span><span class="p">[</span><span class="nx">@patternIndex</span><span class="p">]</span>
    <span class="nv">little      = </span><span class="nx">pattern</span><span class="p">.</span><span class="nx">endianness</span> <span class="o">==</span> <span class="s1">&#39;l&#39;</span>
    <span class="nv">bytes       = </span><span class="nx">pattern</span><span class="p">.</span><span class="nx">bytes</span>

    <span class="vi">@value      = </span><span class="nx">value</span>
    <span class="vi">@offset     = </span><span class="k">if</span> <span class="nx">little</span> <span class="k">then</span> <span class="mi">0</span> <span class="k">else</span> <span class="nx">bytes</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="vi">@increment  = </span><span class="k">if</span> <span class="nx">little</span> <span class="k">then</span> <span class="mi">1</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
    <span class="vi">@terminal   = </span><span class="k">if</span> <span class="nx">little</span> <span class="k">then</span> <span class="nx">bytes</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>

<span class="nv">bufferize = </span><span class="nf">(array) -&gt;</span>
  <span class="nv">buffer = </span><span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="nx">array</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
  <span class="k">for</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">array</span>
    <span class="nx">buffer</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">b</span>
  <span class="nx">buffer</span>

<span class="nv">transforms =</span>
  <span class="nv">str: </span><span class="nf">(encoding, parsing, field, value) -&gt;</span>
    <span class="k">if</span> <span class="nx">parsing</span>
      <span class="k">if</span> <span class="o">not</span> <span class="p">(</span><span class="nx">value</span> <span class="k">instanceof</span> <span class="nx">Buffer</span><span class="p">)</span>
        <span class="nv">value = </span><span class="nx">bufferize</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span>
      <span class="k">if</span> <span class="sr">/^ascii$/i</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">encoding</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Broken and waiting on <a href="http://github.com/ry/node/issues/issue/297">297</a>.
If the top bit is set, it is not ASCII, so we zero the value.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">value</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span>
          <span class="nx">value</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="nx">value</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span>
        <span class="nv">encoding = </span><span class="s2">&quot;utf8&quot;</span>
      <span class="nv">length = </span><span class="nx">value</span><span class="p">.</span><span class="nx">length</span>
      <span class="nx">length</span> <span class="o">-=</span> <span class="nx">field</span><span class="p">.</span><span class="nx">terminator</span><span class="p">.</span><span class="nx">length</span> <span class="k">if</span> <span class="nx">field</span><span class="p">.</span><span class="nx">terminator</span>
      <span class="nx">value</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="nx">encoding</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">length</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="k">if</span> <span class="nx">field</span><span class="p">.</span><span class="nx">terminator</span>
        <span class="nx">value</span> <span class="o">+=</span> <span class="nx">field</span><span class="p">.</span><span class="nx">terminator</span>
      <span class="nv">buffer = </span><span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">encoding</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">encoding</span> <span class="o">is</span> <span class="s2">&quot;ascii&quot;</span>
        <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">buffer</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span>
          <span class="nx">buffer</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="nx">value</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="o">is</span> <span class="s1">&#39;\0&#39;</span>
      <span class="nx">buffer</span>

  <span class="nv">ascii: </span><span class="nf">(parsing, field, value) -&gt;</span>
    <span class="nx">transforms</span><span class="p">.</span><span class="nx">str</span><span class="p">(</span><span class="s2">&quot;ascii&quot;</span><span class="p">,</span> <span class="nx">parsing</span><span class="p">,</span> <span class="nx">field</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span>

  <span class="nv">utf8: </span><span class="nf">(parsing, field, value) -&gt;</span>
    <span class="nx">transforms</span><span class="p">.</span><span class="nx">str</span><span class="p">(</span><span class="s2">&quot;utf8&quot;</span><span class="p">,</span> <span class="nx">parsing</span><span class="p">,</span> <span class="nx">field</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span>

  <span class="nv">pad: </span><span class="nf">(character, length, parsing, field, value) -&gt;</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">parsing</span>
      <span class="k">while</span> <span class="nx">value</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="nx">length</span>
        <span class="nv">value = </span><span class="nx">character</span> <span class="o">+</span> <span class="nx">value</span>
    <span class="nx">value</span>

  <span class="nv">atoi: </span><span class="nf">(base, parsing, field, value) -&gt;</span>
    <span class="k">if</span> <span class="nx">parsing</span> <span class="k">then</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">base</span><span class="p">)</span> <span class="k">else</span> <span class="nx">value</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="nx">base</span><span class="p">)</span>

  <span class="nv">atof: </span><span class="nf">(parsing, field, value) -&gt;</span>
    <span class="k">if</span> <span class="nx">parsing</span> <span class="k">then</span> <span class="nb">parseFloat</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="k">else</span> <span class="nx">value</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>

<span class="k">class</span> <span class="nx">ReadableStream</span> <span class="k">extends</span> <span class="nx">stream</span><span class="p">.</span><span class="nx">Stream</span>
  <span class="nv">constructor: </span><span class="nf">(@parser, @length) -&gt;</span>
  <span class="nv">setEncoding: </span><span class="nf">(encoding) -&gt;</span>
    <span class="vi">@_decoder = </span><span class="k">new</span> <span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;string_decoder&quot;</span><span class="p">).</span><span class="nx">StringDecoder</span><span class="p">)(</span><span class="nx">encoding</span><span class="p">)</span>
  <span class="nv">_delegate: </span><span class="nf">(method) -&gt;</span> <span class="nx">@parser</span><span class="p">.</span><span class="nx">piped</span><span class="p">[</span><span class="nx">method</span><span class="p">]()</span> <span class="k">if</span> <span class="nx">@parser</span><span class="p">.</span><span class="nx">piped</span>
  <span class="nv">pause: </span><span class="o">-&gt;</span>
    <span class="nx">@_delegate</span> <span class="s2">&quot;pause&quot;</span>
    <span class="vi">@parser.paused = </span><span class="kc">true</span>
  <span class="nv">resume: </span><span class="o">-&gt;</span>
    <span class="nx">@_delegate</span> <span class="s2">&quot;resume&quot;</span>
    <span class="vi">@parser.paused = </span><span class="kc">false</span>
  <span class="nv">destroySoon: </span><span class="o">-&gt;</span>
    <span class="nx">@_delegate</span> <span class="s2">&quot;destroySoon&quot;</span>
    <span class="nx">@parser</span><span class="p">.</span><span class="nx">piped</span><span class="p">.</span><span class="nx">destroySoon</span><span class="p">()</span> <span class="k">if</span> <span class="nx">@parser</span><span class="p">.</span><span class="nx">piped</span>
  <span class="nv">destroy: </span><span class="o">-&gt;</span>
    <span class="nx">@_delegate</span> <span class="s2">&quot;destroy&quot;</span>
    <span class="vi">@aprser.destroyed = </span><span class="kc">false</span>
  <span class="nv">_end: </span><span class="o">-&gt;</span>
    <span class="nx">@emit</span> <span class="s2">&quot;end&quot;</span>
    <span class="vi">@parser._stream = </span><span class="kc">null</span>
  <span class="nv">_write: </span><span class="nf">(slice) -&gt;</span>
    <span class="k">if</span> <span class="nx">@_decoder</span>
      <span class="nv">string = </span><span class="nx">@_decoder</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">slice</span><span class="p">)</span>
      <span class="nx">@emit</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="nx">string</span> <span class="k">if</span> <span class="nx">string</span><span class="p">.</span><span class="nx">length</span>
    <span class="k">else</span>
      <span class="nx">@emit</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="nx">slice</span>

<span class="nv">module.exports.Parser = </span><span class="k">class</span> <span class="nx">Parser</span> <span class="k">extends</span> <span class="nx">Packet</span>
  <span class="nv">constructor: </span><span class="nf">(self) -&gt;</span>
    <span class="k">super</span> <span class="nx">self</span>
    <span class="vi">@writable = </span><span class="kc">true</span>

  <span class="nv">data: </span><span class="nf">(data...)   -&gt;</span> <span class="vi">@user = </span><span class="nx">data</span>

  <span class="nv">getBytesRead: </span>    <span class="o">-&gt;</span> <span class="nx">@bytesRead</span>

  <span class="nv">nextField: </span><span class="o">-&gt;</span>
    <span class="nv">pattern       = </span><span class="nx">@pattern</span><span class="p">[</span><span class="nx">@patternIndex</span><span class="p">]</span>
    <span class="vi">@repeat       = </span><span class="nx">pattern</span><span class="p">.</span><span class="nx">repeat</span>
    <span class="vi">@index        = </span><span class="mi">0</span>
    <span class="vi">@_skipping    = </span><span class="kc">null</span>
    <span class="vi">@terminated   = </span><span class="o">not</span> <span class="nx">pattern</span><span class="p">.</span><span class="nx">terminator</span>

    <span class="nx">@_fields</span><span class="p">.</span><span class="nx">push</span> <span class="p">[]</span> <span class="k">if</span> <span class="nx">pattern</span><span class="p">.</span><span class="nx">arrayed</span> <span class="o">and</span> <span class="nx">pattern</span><span class="p">.</span><span class="nx">endianness</span> <span class="o">isnt</span> <span class="s2">&quot;x&quot;</span>

  <span class="nv">nextValue: </span><span class="o">-&gt;</span>
    <span class="nv">pattern = </span><span class="nx">@pattern</span><span class="p">[</span><span class="nx">@patternIndex</span><span class="p">]</span>

    <span class="k">if</span> <span class="nx">pattern</span><span class="p">.</span><span class="nx">endianness</span> <span class="o">is</span> <span class="s2">&quot;x&quot;</span>
      <span class="vi">@_skipping  = </span><span class="nx">pattern</span><span class="p">.</span><span class="nx">bytes</span>
    <span class="k">else</span>
      <span class="nv">little      = </span><span class="nx">pattern</span><span class="p">.</span><span class="nx">endianness</span> <span class="o">==</span> <span class="s2">&quot;l&quot;</span>
      <span class="nv">bytes       = </span><span class="nx">pattern</span><span class="p">.</span><span class="nx">bytes</span>

      <span class="k">if</span> <span class="nx">pattern</span><span class="p">.</span><span class="nx">unpacked</span>
        <span class="nv">value = </span><span class="p">[]</span>
      <span class="k">else</span>
        <span class="nv">value = </span><span class="mi">0</span>

      <span class="k">super</span> <span class="nx">value</span>

  <span class="nv">unpack: </span><span class="o">-&gt;</span>
    <span class="nv">bytes   = </span><span class="nx">@value</span>
    <span class="k">return</span> <span class="kc">null</span> <span class="nx">unless</span> <span class="nx">bytes</span><span class="o">?</span>
    <span class="nv">pattern = </span><span class="nx">@pattern</span><span class="p">[</span><span class="nx">@patternIndex</span><span class="p">]</span>
    <span class="k">if</span> <span class="nx">pattern</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="s2">&quot;h&quot;</span>
      <span class="nx">hex</span> <span class="nx">bytes</span><span class="p">.</span><span class="nx">reverse</span><span class="p">()</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">pattern</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="s2">&quot;f&quot;</span>
      <span class="k">if</span> <span class="nx">pattern</span><span class="p">.</span><span class="nx">bits</span> <span class="o">==</span> <span class="mi">32</span>
        <span class="nx">ieee754</span><span class="p">.</span><span class="nx">fromIEEE754Single</span><span class="p">(</span><span class="nx">bytes</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="nx">ieee754</span><span class="p">.</span><span class="nx">fromIEEE754Double</span><span class="p">(</span><span class="nx">bytes</span><span class="p">)</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">pattern</span><span class="p">.</span><span class="nx">signed</span>
      <span class="nv">value = </span><span class="mi">0</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">bytes</span><span class="p">[</span><span class="nx">bytes</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x80</span>
        <span class="nv">top = </span><span class="nx">bytes</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">top</span><span class="p">]</span>
          <span class="nx">value</span> <span class="o">+=</span> <span class="p">(</span><span class="o">~</span><span class="nx">bytes</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span>  <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>~1 == -2.
To get the two's compliment as a positive value you use ~1 &amp; 0xff == 254. </p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">value</span> <span class="o">+=</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="nx">bytes</span><span class="p">[</span><span class="nx">top</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="nx">top</span><span class="p">)</span>
        <span class="nx">value</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="nx">value</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
      <span class="k">else</span>
        <span class="nv">top = </span><span class="nx">bytes</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">top</span><span class="p">]</span>
          <span class="nx">value</span> <span class="o">+=</span> <span class="p">(</span><span class="nx">bytes</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span>  <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span>
        <span class="nx">value</span> <span class="o">+=</span> <span class="p">(</span><span class="nx">bytes</span><span class="p">[</span><span class="nx">top</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="nx">top</span><span class="p">)</span>
      <span class="nx">value</span>
    <span class="k">else</span>
      <span class="nx">bytes</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Set the next packet to parse by providing a named packet name or a packet
pattern, with an optional <code>callback</code>. The optional <code>callback</code> will override
the callback assigned to a named pattern.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">parse: </span><span class="nf">(nameOrPattern, callback) -&gt;</span>
    <span class="nv">packet        = </span><span class="nx">@_packets</span><span class="p">[</span><span class="nx">nameOrPattern</span><span class="p">]</span> <span class="o">or</span> <span class="p">{}</span>
    <span class="nv">pattern       = </span><span class="nx">packet</span><span class="p">.</span><span class="nx">pattern</span> <span class="o">or</span> <span class="nx">parsePattern</span><span class="p">(</span><span class="nx">nameOrPattern</span><span class="p">)</span>
    <span class="nx">callback</span>    <span class="o">or=</span> <span class="nx">packet</span><span class="p">.</span><span class="nx">callback</span> <span class="o">or</span> <span class="nx">noop</span>

    <span class="vi">@pattern      = </span><span class="nx">pattern</span>
    <span class="vi">@callback     = </span><span class="nx">callback</span>
    <span class="vi">@patternIndex = </span><span class="mi">0</span>
    <span class="vi">@_fields      = </span><span class="p">[]</span>

    <span class="nx">@nextField</span><span class="p">()</span>
    <span class="nx">@nextValue</span><span class="p">()</span>

  <span class="nv">skip: </span><span class="nf">(length, @callback) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Create a bogus pattern to enter the parse loop where the stream is fed in
the skipping branch. The length is passed to the callback simply because
the parse loop expects there to be a field.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@pattern = </span><span class="p">[</span> <span class="p">{}</span> <span class="p">]</span>
    <span class="vi">@terminated   = </span><span class="kc">true</span>
    <span class="vi">@index        = </span><span class="mi">0</span>
    <span class="vi">@repeat       = </span><span class="mi">1</span>
    <span class="vi">@patternIndex = </span><span class="mi">0</span>
    <span class="vi">@_fields      = </span><span class="p">[</span> <span class="nx">length</span> <span class="p">]</span>

    <span class="vi">@_skipping = </span><span class="nx">length</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Construct a readable stream for the next length bytes calling callback when
they have been read.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">stream: </span><span class="nf">(length, callback) -&gt;</span>
    <span class="nx">@skip</span><span class="p">(</span><span class="nx">length</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span>
    <span class="vi">@_stream = </span><span class="k">new</span> <span class="nx">ReadableStream</span><span class="p">(</span><span class="err">@</span><span class="p">,</span> <span class="nx">length</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span>
    
  <span class="nv">write: </span><span class="nf">(buffer, encoding) -&gt;</span>
    <span class="k">if</span> <span class="k">typeof</span> <span class="nx">buffer</span> <span class="o">is</span> <span class="s2">&quot;string&quot;</span>
      <span class="nv">buffer = </span><span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="nx">buffer</span><span class="p">,</span> <span class="nx">encoding</span> <span class="o">or</span> <span class="s2">&quot;utf8&quot;</span><span class="p">)</span>
    <span class="nx">@read</span><span class="p">(</span><span class="nx">buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">buffer</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <h4>parser.read(buffer[, offset][, length])</h4>

<p>The <code>read</code> method reads from the buffer, returning when the current pattern is
read, or the end of the buffer is reached.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Read from the <code>buffer</code> for the given <code>offset</code> and length.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">read: </span><span class="nf">(buffer, offset, length) -&gt;</span>
    <span class="nx">offset</span> <span class="o">or=</span> <span class="mi">0</span>
    <span class="nx">length</span> <span class="o">or=</span> <span class="nx">buffer</span><span class="p">.</span><span class="nx">length</span>
    <span class="nv">start    = </span><span class="nx">@bytesRead</span>
    <span class="nv">end      = </span><span class="nx">offset</span> <span class="o">+</span> <span class="nx">length</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>We set the pattern to null when all the fields have been read, so while
there is a pattern to fill and bytes to read.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">b</span>
    <span class="k">while</span> <span class="nx">@pattern</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">and</span> <span class="nx">offset</span> <span class="o">&lt;</span> <span class="nx">end</span>
      <span class="k">if</span> <span class="nx">@_skipping</span><span class="o">?</span>
        <span class="nv">advance      = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">@_skipping</span><span class="p">,</span> <span class="nx">end</span> <span class="o">-</span> <span class="nx">offset</span><span class="p">)</span>
        <span class="nv">begin        = </span><span class="nx">offset</span>
        <span class="nx">offset</span>      <span class="o">+=</span> <span class="nx">advance</span>
        <span class="nx">@_skipping</span>  <span class="o">-=</span> <span class="nx">advance</span>
        <span class="nx">@bytesRead</span>  <span class="o">+=</span> <span class="nx">advance</span>
        <span class="k">if</span> <span class="nx">@_stream</span>
          <span class="nx">@_stream</span><span class="p">.</span><span class="nx">_write</span><span class="p">(</span><span class="nx">buffer</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">begin</span><span class="p">,</span> <span class="nx">begin</span> <span class="o">+</span> <span class="nx">advance</span><span class="p">))</span> <span class="k">if</span> <span class="nx">advance</span>
          <span class="nx">@_stream</span><span class="p">.</span><span class="nx">_end</span><span class="p">()</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">@_skipping</span>
        <span class="k">if</span> <span class="nx">@_skipping</span>
          <span class="k">return</span> <span class="nx">@bytesRead</span> <span class="o">-</span> <span class="nx">start</span>
        <span class="k">else</span>
          <span class="vi">@_skipping = </span><span class="kc">null</span>

      <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>If the pattern is unpacked, the value we're populating is an array.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="nx">@pattern</span><span class="p">[</span><span class="nx">@patternIndex</span><span class="p">].</span><span class="nx">unpacked</span>
          <span class="nx">loop</span>
            <span class="nv">b = </span><span class="nx">buffer</span><span class="p">[</span><span class="nx">offset</span><span class="p">]</span>
            <span class="nx">@bytesRead</span><span class="o">++</span>
            <span class="nx">offset</span><span class="o">++</span>
            <span class="nx">@value</span><span class="p">[</span><span class="nx">@offset</span><span class="p">]</span> <span class="o">=</span> <span class="nx">b</span>
            <span class="nx">@offset</span> <span class="o">+=</span> <span class="nx">@increment</span>
            <span class="k">break</span> <span class="k">if</span> <span class="nx">@offset</span> <span class="o">is</span> <span class="nx">@terminal</span>
            <span class="k">return</span> <span class="nx">@bytesRead</span> <span class="o">-</span> <span class="nx">start</span> <span class="k">if</span> <span class="nx">offset</span> <span class="o">is</span> <span class="nx">end</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>If we are parsing an array, and repeat is 0
It is essentially an empty array
We don't parse anything</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">else</span> <span class="k">if</span> <span class="nx">@pattern</span><span class="p">[</span><span class="nx">@patternIndex</span><span class="p">].</span><span class="nx">arrayed</span> <span class="o">and</span> <span class="nx">@pattern</span><span class="p">[</span><span class="nx">@patternIndex</span><span class="p">].</span><span class="nx">repeat</span> <span class="o">==</span> <span class="mi">0</span>
          <span class="vi">@value = </span><span class="kc">null</span>
          <span class="vi">@terminated = </span><span class="kc">true</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Otherwise we're packing bytes into an unsigned integer, the most
common case.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">else</span>
          <span class="nx">loop</span>
            <span class="nv">b = </span><span class="nx">buffer</span><span class="p">[</span><span class="nx">offset</span><span class="p">]</span>
            <span class="nx">@bytesRead</span><span class="o">++</span>
            <span class="nx">offset</span><span class="o">++</span>
            <span class="nx">@value</span> <span class="o">+=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="nx">@offset</span><span class="p">)</span> <span class="o">*</span> <span class="nx">b</span>
            <span class="nx">@offset</span> <span class="o">+=</span> <span class="nx">@increment</span>
            <span class="k">break</span> <span class="k">if</span> <span class="nx">@offset</span> <span class="o">==</span> <span class="nx">@terminal</span>
            <span class="k">return</span> <span class="nx">@bytesRead</span> <span class="o">-</span> <span class="nx">start</span> <span class="k">if</span> <span class="nx">offset</span> <span class="o">is</span> <span class="nx">end</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Unpack the field value.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">field = </span><span class="nx">@unpack</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>If we are filling an array field the current fields is an array,
otherwise current field is the value we've just read.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="nx">@pattern</span><span class="p">[</span><span class="nx">@patternIndex</span><span class="p">].</span><span class="nx">arrayed</span>
          <span class="nx">@_fields</span><span class="p">[</span><span class="nx">@_fields</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">field</span><span class="p">)</span> <span class="k">if</span> <span class="nx">field</span><span class="o">?</span>
        <span class="k">else</span>
          <span class="nx">@_fields</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">field</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>If we've not yet hit our terminator, check for the terminator. If we've
hit the terminator, and we do not have a maximum size to fill, then
terminate by setting up the array to terminate.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="o">not</span> <span class="nx">@terminated</span>
        <span class="k">if</span> <span class="nx">@pattern</span><span class="p">[</span><span class="nx">@patternIndex</span><span class="p">].</span><span class="nx">terminator</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="nx">field</span>
          <span class="vi">@terminated = </span><span class="kc">true</span>
          <span class="k">if</span> <span class="nx">@repeat</span> <span class="o">==</span> <span class="nb">Number</span><span class="p">.</span><span class="nx">MAX_VALUE</span>
            <span class="vi">@repeat = </span><span class="nx">@index</span> <span class="o">+</span> <span class="mi">1</span>
          <span class="k">else</span>
            <span class="vi">@_skipping = </span><span class="p">(</span><span class="nx">@repeat</span> <span class="o">-</span> <span class="p">(</span><span class="o">++</span><span class="nx">@index</span><span class="p">))</span> <span class="o">*</span> <span class="nx">@pattern</span><span class="p">[</span><span class="nx">@patternIndex</span><span class="p">].</span><span class="nx">bytes</span>
            <span class="k">if</span> <span class="nx">@_skipping</span>
              <span class="vi">@repeat = </span><span class="nx">@index</span> <span class="o">+</span> <span class="mi">1</span>
              <span class="k">continue</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>If we are reading an arrayed pattern and we have not read all of the
array elements, we repeat the current field type.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="o">++</span><span class="nx">@index</span> <span class="o">&lt;</span>  <span class="nx">@repeat</span>
        <span class="nx">@nextValue</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>If we have read all of the pattern fields, call the associated callback.
We add the parser and the user suppilied additional arguments onto the
callback arguments.</p>

<p>The pattern is set to null, our terminal condition, because the callback
may specify a subsequent packet to parse.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">else</span> <span class="k">if</span> <span class="o">++</span><span class="nx">@patternIndex</span> <span class="o">==</span> <span class="nx">@pattern</span><span class="p">.</span><span class="nx">length</span>
        <span class="nx">@_fields</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">@pipeline</span><span class="p">(</span><span class="nx">@pattern</span><span class="p">[</span><span class="nx">@patternIndex</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">],</span> <span class="nx">@_fields</span><span class="p">.</span><span class="nx">pop</span><span class="p">()))</span>

        <span class="nx">@_fields</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
        <span class="k">for</span> <span class="nx">p</span> <span class="k">in</span> <span class="nx">@user</span> <span class="o">or</span> <span class="p">[]</span>
          <span class="nx">@_fields</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span>

        <span class="vi">@pattern = </span><span class="kc">null</span>

        <span class="nx">@callback</span><span class="p">.</span><span class="nx">apply</span> <span class="nx">@self</span><span class="p">,</span> <span class="nx">@_fields</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Otherwise we proceed to the next field in the packet pattern.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">else</span>
        <span class="k">if</span> <span class="nx">@pattern</span><span class="p">[</span><span class="nx">@patternIndex</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="nx">endianness</span> <span class="o">isnt</span> <span class="s2">&quot;x&quot;</span>
          <span class="k">if</span> <span class="nx">@pattern</span><span class="p">[</span><span class="nx">@patternIndex</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="nx">length</span>
            <span class="nx">@pattern</span><span class="p">[</span><span class="nx">@patternIndex</span><span class="p">].</span><span class="nv">repeat = </span><span class="nx">@_fields</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span>
          <span class="k">else</span>
            <span class="nx">@_fields</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">@pipeline</span><span class="p">(</span><span class="nx">@pattern</span><span class="p">[</span><span class="nx">@patternIndex</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="nx">@_fields</span><span class="p">.</span><span class="nx">pop</span><span class="p">()))</span>

        <span class="nx">@nextField</span><span class="p">()</span>
        <span class="nx">@nextValue</span><span class="p">()</span>

    <span class="nx">@bytesRead</span> <span class="o">-</span> <span class="nx">start</span>

  <span class="nv">close: </span><span class="o">-&gt;</span>
    <span class="nx">@emit</span> <span class="s2">&quot;close&quot;</span>

  <span class="nv">end: </span><span class="nf">(string, encoding) -&gt;</span>
    <span class="nx">@write</span><span class="p">(</span><span class="nx">string</span><span class="p">,</span> <span class="nx">encoding</span><span class="p">)</span> <span class="k">if</span> <span class="nx">string</span>
    <span class="nx">@emit</span> <span class="s2">&quot;end&quot;</span>

<span class="k">class</span> <span class="nx">WritableStream</span> <span class="k">extends</span> <span class="nx">stream</span><span class="p">.</span><span class="nx">Stream</span>
  <span class="nv">constructor: </span><span class="nf">(@_length, @_serializer, @_callback) -&gt;</span>
    <span class="vi">@writable = </span><span class="kc">true</span>
    <span class="vi">@_written = </span><span class="mi">0</span>

  <span class="nv">write: </span><span class="nf">(buffer, encoding) -&gt;</span>
    <span class="k">if</span> <span class="k">typeof</span> <span class="nx">buffer</span> <span class="o">is</span> <span class="s2">&quot;string&quot;</span>
      <span class="nv">buffer = </span><span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="nx">buffer</span><span class="p">,</span> <span class="nx">encoding</span> <span class="o">or</span> <span class="s2">&quot;utf8&quot;</span><span class="p">)</span>
    <span class="nx">@_written</span> <span class="o">+=</span> <span class="nx">buffer</span><span class="p">.</span><span class="nx">length</span>
    <span class="nx">@_serializer</span><span class="p">.</span><span class="nx">write</span> <span class="nx">buffer</span>
    <span class="k">if</span> <span class="nx">@_written</span> <span class="o">&gt;</span> <span class="nx">@_length</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s2">&quot;buffer overflow&quot;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">@_wrtten</span> <span class="o">==</span> <span class="nx">@_length</span>
      <span class="vi">@_serializer._stream = </span><span class="kc">null</span>
      <span class="k">if</span> <span class="nx">@_callback</span>
        <span class="nx">@_callback</span><span class="p">.</span><span class="nx">apply</span> <span class="nx">@_serializer</span><span class="p">.</span><span class="nx">self</span><span class="p">,</span> <span class="nx">@_length</span>


  <span class="nv">end: </span><span class="nf">(splat...) -&gt;</span>
    <span class="nx">@write</span><span class="p">.</span><span class="nx">apply</span> <span class="err">@</span><span class="p">,</span> <span class="nx">splat</span> <span class="k">if</span> <span class="nx">splat</span><span class="p">.</span><span class="nx">length</span>
  

<span class="nv">module.exports.Serializer = </span><span class="k">class</span> <span class="nx">Serializer</span> <span class="k">extends</span> <span class="nx">Packet</span>
  <span class="nv">constructor: </span><span class="nf">(self) -&gt;</span>
    <span class="k">super</span> <span class="nx">self</span>
    <span class="vi">@readable = </span><span class="kc">true</span>
    <span class="vi">@_buffer = </span><span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
    <span class="vi">@streaming = </span><span class="kc">false</span>

  <span class="nv">getBytesWritten: </span><span class="o">-&gt;</span> <span class="nx">@bytesWritten</span>

  <span class="nv">packet: </span><span class="nf">(name, pattern, callback) -&gt;</span>
    <span class="k">super</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">pattern</span><span class="p">,</span> <span class="nx">callback</span>
    <span class="k">for</span> <span class="nx">part</span> <span class="k">in</span> <span class="nx">@_packets</span><span class="p">[</span><span class="nx">name</span><span class="p">].</span><span class="nx">pattern</span>
      <span class="k">if</span> <span class="nx">part</span><span class="p">.</span><span class="nx">transforms</span>
        <span class="nx">part</span><span class="p">.</span><span class="nx">transforms</span><span class="p">.</span><span class="nx">reverse</span><span class="p">()</span>

  <span class="nv">nextField: </span><span class="o">-&gt;</span>
    <span class="nv">pattern       = </span><span class="nx">@pattern</span><span class="p">[</span><span class="nx">@patternIndex</span><span class="p">]</span>
    <span class="vi">@repeat       = </span><span class="nx">pattern</span><span class="p">.</span><span class="nx">repeat</span>
    <span class="vi">@terminated   = </span><span class="o">not</span> <span class="nx">pattern</span><span class="p">.</span><span class="nx">terminator</span>
    <span class="vi">@terminates   = </span><span class="o">not</span> <span class="nx">@terminated</span>
    <span class="vi">@index        = </span><span class="mi">0</span>

    <span class="k">delete</span>        <span class="nx">@padding</span>

    <span class="k">if</span> <span class="nx">pattern</span><span class="p">.</span><span class="nx">endianness</span> <span class="o">is</span> <span class="s2">&quot;x&quot;</span>
      <span class="nx">@_outgoing</span><span class="p">.</span><span class="nx">splice</span> <span class="nx">@patternIndex</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">null</span>
      <span class="k">if</span> <span class="nx">pattern</span><span class="p">.</span><span class="nx">padding</span><span class="o">?</span>
        <span class="vi">@padding = </span><span class="nx">pattern</span><span class="p">.</span><span class="nx">padding</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>Setup the next field in the current pattern to read or write.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">nextValue: </span><span class="o">-&gt;</span>
    <span class="nv">pattern = </span><span class="nx">@pattern</span><span class="p">[</span><span class="nx">@patternIndex</span><span class="p">]</span>

    <span class="k">if</span> <span class="nx">pattern</span><span class="p">.</span><span class="nx">endianness</span> <span class="o">is</span> <span class="s2">&quot;x&quot;</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">@padding</span><span class="o">?</span>
        <span class="vi">@_skipping = </span><span class="nx">pattern</span><span class="p">.</span><span class="nx">bytes</span>
    <span class="k">else</span>
      <span class="k">if</span> <span class="nx">@padding</span><span class="o">?</span>
        <span class="nv">value = </span><span class="nx">@padding</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nx">pattern</span><span class="p">.</span><span class="nx">arrayed</span>
        <span class="nv">value = </span><span class="nx">@_outgoing</span><span class="p">[</span><span class="nx">@patternIndex</span><span class="p">][</span><span class="nx">@index</span><span class="p">]</span>
      <span class="k">else</span>
        <span class="k">if</span> <span class="nx">pattern</span><span class="p">.</span><span class="nx">length</span>
          <span class="nv">repeat = </span><span class="nx">@_outgoing</span><span class="p">[</span><span class="nx">@patternIndex</span><span class="p">].</span><span class="nx">length</span>
          <span class="nx">@_outgoing</span><span class="p">.</span><span class="nx">splice</span> <span class="nx">@patternIndex</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">repeat</span>
          <span class="nx">@pattern</span><span class="p">[</span><span class="nx">@patternIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">].</span><span class="nv">repeat = </span><span class="nx">repeat</span>
        <span class="nv">value = </span><span class="nx">@_outgoing</span><span class="p">[</span><span class="nx">@patternIndex</span><span class="p">]</span>
      <span class="k">if</span> <span class="nx">pattern</span><span class="p">.</span><span class="nx">unpacked</span>
        <span class="nv">value = </span><span class="nx">@pack</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span>

      <span class="k">super</span> <span class="nx">value</span>

  <span class="nv">stream: </span><span class="nf">(length) -&gt;</span>
    <span class="vi">@_stream = </span><span class="k">new</span> <span class="nx">WritableStream</span><span class="p">(</span><span class="nx">length</span><span class="p">,</span> <span class="err">@</span><span class="p">)</span>

  <span class="nv">_pipe: </span><span class="nf">(destination, options) -&gt;</span>
    <span class="k">if</span> <span class="nx">destination</span> <span class="k">instanceof</span> <span class="nb">Array</span>
      <span class="vi">@_buffer = </span><span class="nx">destination</span>
      <span class="vi">@_bufferLength = </span><span class="nb">Number</span><span class="p">.</span><span class="nx">MAX_VALUE</span>
      <span class="vi">@_streaming = </span><span class="kc">false</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">destination</span> <span class="k">instanceof</span> <span class="nx">Buffer</span>
      <span class="vi">@_buffer = </span><span class="nx">destination</span>
      <span class="vi">@_bufferLength = </span><span class="nx">destination</span><span class="p">.</span><span class="nx">length</span>
      <span class="vi">@_streaming = </span><span class="kc">false</span>
    <span class="k">else</span>
      <span class="vi">@_buffer = </span><span class="p">(</span><span class="nx">@_ownBuffer</span> <span class="o">or=</span> <span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="mi">1024</span><span class="p">))</span>
      <span class="vi">@_bufferLength = </span><span class="nx">@_ownBuffer</span><span class="p">.</span><span class="nx">length</span>
      <span class="vi">@_streaming = </span><span class="kc">true</span>
      <span class="k">super</span> <span class="nx">destination</span><span class="p">,</span> <span class="nx">options</span>

  <span class="nv">skip: </span><span class="nf">(length, fill) -&gt;</span>
    <span class="k">while</span> <span class="nx">length</span>
      <span class="nv">size = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">length</span><span class="p">,</span> <span class="nx">@_buffer</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
      <span class="nx">length</span> <span class="o">-=</span> <span class="nx">size</span>
      <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">size</span><span class="p">]</span>
        <span class="nx">@_buffer</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">fill</span>
      <span class="nx">@write</span> <span class="nx">@_buffer</span><span class="p">.</span><span class="nx">slice</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">size</span>

  <span class="nv">buffer: </span><span class="nf">(shiftable...) -&gt;</span>
    <span class="k">if</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">shiftable</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
      <span class="nv">buffer = </span><span class="nx">shiftable</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span>
      <span class="nv">bufferLength = </span><span class="nb">Number</span><span class="p">.</span><span class="nx">MAX_VALUE</span>
      <span class="nv">ownsBuffer = </span><span class="kc">false</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">Buffer</span><span class="p">.</span><span class="nx">isBuffer</span><span class="p">(</span><span class="nx">shiftable</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
      <span class="nv">buffer = </span><span class="nx">shiftable</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span>
      <span class="nv">bufferLength = </span><span class="nx">buffer</span><span class="p">.</span><span class="nx">length</span>
      <span class="nv">ownsBuffer = </span><span class="kc">false</span>
    <span class="k">else</span>
      <span class="nv">buffer = </span><span class="nx">@_buffer</span>
      <span class="nv">bufferLength = </span><span class="nx">@_buffer</span><span class="p">.</span><span class="nx">length</span>
      <span class="nv">ownsBuffer = </span><span class="kc">true</span>

    <span class="nv">callback = </span><span class="nx">@_reset</span><span class="p">(</span><span class="nx">shiftable</span><span class="p">)</span>
    <span class="vi">@callback = </span><span class="nx">noop</span>

    <span class="nv">read = </span><span class="mi">0</span>
    <span class="k">while</span> <span class="nx">@pattern</span>
      <span class="k">if</span> <span class="nx">read</span> <span class="o">is</span> <span class="nx">bufferLength</span>
        <span class="k">if</span> <span class="nx">ownsBuffer</span>
          <span class="nv">expanded = </span><span class="k">new</span> <span class="nx">Buffer</span> <span class="nx">buffer</span><span class="p">.</span><span class="nx">length</span> <span class="o">*</span> <span class="mi">2</span>
          <span class="nx">buffer</span><span class="p">.</span><span class="nx">copy</span><span class="p">(</span><span class="nx">expanded</span><span class="p">)</span>
          <span class="nv">buffer = </span><span class="nx">expanded</span>
        <span class="k">else</span>
          <span class="nx">@emit</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s2">&quot;buffer overflow&quot;</span>
          <span class="k">return</span>
      <span class="nx">read</span> <span class="o">+=</span> <span class="nx">@_serialize</span> <span class="nx">buffer</span><span class="p">,</span> <span class="nx">read</span><span class="p">,</span> <span class="nx">bufferLength</span> <span class="o">-</span> <span class="nx">read</span>

    <span class="vi">@_buffer = </span><span class="nx">buffer</span> <span class="k">if</span> <span class="nx">ownsBuffer</span>

    <span class="nv">slice = </span><span class="nx">buffer</span><span class="p">.</span><span class="nx">slice</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">read</span>
    <span class="nx">callback</span><span class="p">.</span><span class="nx">call</span> <span class="nx">@self</span><span class="p">,</span> <span class="nx">slice</span>

    <span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>Using the airity of the callback might be too clever, when we could simply
choose a name, such as <code>serialize</code> versus <code>buffer</code>, or maybe <code>write</code> versus
<code>buffer</code>, where write writes the buffer when it fills, and buffer gathers
everthing in a buffer, and gives the user an opportunity to make last minute
changes before writing to the stream.</p>

<p>Already have plenty of magic with named versus positional arguments.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">write: </span><span class="nf">(shiftable...) -&gt;</span>
    <span class="k">if</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">shiftable</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
      <span class="nx">shiftable</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="nx">shiftable</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="nx">Buffer</span><span class="p">.</span><span class="nx">isBuffer</span><span class="p">(</span><span class="nx">shiftable</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
      <span class="nv">slice = </span><span class="nx">shiftable</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span>
      <span class="k">if</span> <span class="nx">@_decoder</span>
        <span class="nv">string = </span><span class="nx">@_decoder</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">slice</span><span class="p">)</span>
        <span class="nx">@emit</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="nx">string</span> <span class="k">if</span> <span class="nx">string</span><span class="p">.</span><span class="nx">length</span>
      <span class="k">else</span>
        <span class="nx">@emit</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="nx">slice</span>
    <span class="k">else</span>
      <span class="nv">callback = </span><span class="nx">@_reset</span><span class="p">(</span><span class="nx">shiftable</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>Implementing pause requires callbacks.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="vi">@callback = </span><span class="nx">noop</span>
      <span class="k">while</span> <span class="nx">@pattern</span>
        <span class="nv">read = </span><span class="nx">@_serialize</span><span class="p">(</span><span class="nx">@_buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">@_buffer</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
        <span class="nx">@write</span> <span class="nx">@_buffer</span><span class="p">.</span><span class="nx">slice</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">read</span>
      <span class="nx">callback</span><span class="p">.</span><span class="nx">call</span> <span class="nx">@self</span>

  <span class="nv">_reset: </span><span class="nf">(shiftable) -&gt;</span>
    <span class="k">if</span> <span class="k">typeof</span> <span class="nx">shiftable</span><span class="p">[</span><span class="nx">shiftable</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;function&#39;</span>
      <span class="nv">callback = </span><span class="nx">shiftable</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span>

    <span class="nv">nameOrPattern = </span><span class="nx">shiftable</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span>
    <span class="nv">packet        = </span><span class="nx">@_packets</span><span class="p">[</span><span class="nx">nameOrPattern</span><span class="p">]</span> <span class="o">or</span> <span class="p">{}</span>
    <span class="nv">pattern       = </span><span class="nx">packet</span><span class="p">.</span><span class="nx">pattern</span> <span class="o">or</span> <span class="nx">parsePattern</span><span class="p">(</span><span class="nx">nameOrPattern</span><span class="p">)</span>
    <span class="nx">callback</span>    <span class="o">or=</span> <span class="nx">packet</span><span class="p">.</span><span class="nx">callback</span> <span class="o">or</span> <span class="nx">noop</span>

    <span class="k">if</span> <span class="o">not</span> <span class="nx">packet</span><span class="p">.</span><span class="nx">pattern</span>
      <span class="k">for</span> <span class="nx">part</span> <span class="k">in</span> <span class="nx">pattern</span>
        <span class="k">if</span> <span class="nx">part</span><span class="p">.</span><span class="nx">transforms</span>
          <span class="nx">part</span><span class="p">.</span><span class="nx">transforms</span><span class="p">.</span><span class="nx">reverse</span><span class="p">()</span>

    <span class="vi">@pattern      = </span><span class="nx">pattern</span>
    <span class="vi">@callback     = </span><span class="nx">noop</span>
    <span class="vi">@patternIndex = </span><span class="mi">0</span>

    <span class="k">if</span> <span class="nx">shiftable</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">1</span> <span class="o">and</span>
        <span class="k">typeof</span> <span class="nx">shiftable</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">is</span> <span class="s2">&quot;object&quot;</span> <span class="o">and</span>
        <span class="o">not</span> <span class="p">(</span><span class="nx">shiftable</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">instanceof</span> <span class="nb">Array</span><span class="p">)</span>
      <span class="nv">object = </span><span class="nx">shiftable</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span>
      <span class="vi">@_outgoing = </span><span class="p">[]</span>
      <span class="k">for</span> <span class="nx">part</span> <span class="k">in</span> <span class="nx">@pattern</span>
        <span class="nx">@_outgoing</span><span class="p">.</span><span class="nx">push</span> <span class="k">if</span> <span class="nx">part</span><span class="p">.</span><span class="nx">name</span> <span class="k">then</span> <span class="nx">object</span><span class="p">[</span><span class="nx">part</span><span class="p">.</span><span class="nx">name</span><span class="p">]</span> <span class="k">else</span> <span class="kc">null</span>
    <span class="k">else</span>
      <span class="vi">@_outgoing  = </span><span class="nx">shiftable</span>

    <span class="k">for</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">@_outgoing</span>
      <span class="nx">@_outgoing</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@pipeline</span><span class="p">(</span><span class="nx">pattern</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">value</span><span class="p">)</span>

    <span class="nx">@nextField</span><span class="p">()</span>
    <span class="nx">@nextValue</span><span class="p">()</span>

    <span class="nx">callback</span>

  <span class="nv">close: </span><span class="o">-&gt;</span>
    <span class="nx">@emit</span> <span class="s2">&quot;end&quot;</span>

  <span class="nv">pack: </span><span class="nf">(value) -&gt;</span>
    <span class="nv">pattern = </span><span class="nx">@pattern</span><span class="p">[</span><span class="nx">@patternIndex</span><span class="p">]</span>
    <span class="k">if</span> <span class="nx">pattern</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="s2">&quot;f&quot;</span>
      <span class="k">if</span> <span class="nx">pattern</span><span class="p">.</span><span class="nx">bits</span> <span class="o">==</span> <span class="mi">32</span>
        <span class="nx">ieee754</span><span class="p">.</span><span class="nx">toIEEE754Single</span> <span class="nx">value</span>
      <span class="k">else</span>
        <span class="nx">ieee754</span><span class="p">.</span><span class="nx">toIEEE754Double</span> <span class="nx">value</span>
    <span class="k">else</span>
      <span class="nx">value</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <h4>serializer.write(buffer[, offset][, length])</h4>

<p>The <code>write</code> method writes to the buffer, returning when the current pattern is
written, or the end of the buffer is reached.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>Write to the <code>buffer</code> in the region defined by the given <code>offset</code> and <code>length</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">_serialize: </span><span class="nf">(buffer, offset, length) -&gt;</span>
    <span class="nv">start     = </span><span class="nx">offset</span>
    <span class="nv">end       = </span><span class="nx">offset</span> <span class="o">+</span> <span class="nx">length</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>We set the pattern to null when all the fields have been written, so while
there is a pattern to fill and space to write.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">while</span> <span class="nx">@pattern</span> <span class="o">and</span> <span class="nx">offset</span> <span class="o">&lt;</span> <span class="nx">end</span>
      <span class="k">if</span> <span class="nx">@_skipping</span>
        <span class="nv">advance         = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">@_skipping</span><span class="p">,</span> <span class="nx">end</span> <span class="o">-</span> <span class="nx">offset</span><span class="p">)</span>
        <span class="nx">offset</span>         <span class="o">+=</span> <span class="nx">advance</span>
        <span class="nx">@_skipping</span>      <span class="o">-=</span> <span class="nx">advance</span>
        <span class="nx">@bytesWritten</span>  <span class="o">+=</span> <span class="nx">advance</span>
        <span class="k">return</span> <span class="nx">offset</span> <span class="o">-</span> <span class="nx">start</span> <span class="k">if</span> <span class="nx">@_skipping</span>

      <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>If the pattern is unpacked, the value we're writing is an array.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="nx">@pattern</span><span class="p">[</span><span class="nx">@patternIndex</span><span class="p">].</span><span class="nx">unpacked</span>
          <span class="nx">loop</span>
            <span class="nx">buffer</span><span class="p">[</span><span class="nx">offset</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@value</span><span class="p">[</span><span class="nx">@offset</span><span class="p">]</span>
            <span class="nx">@offset</span> <span class="o">+=</span> <span class="nx">@increment</span>
            <span class="nx">@bytesWritten</span><span class="o">++</span>
            <span class="nx">offset</span><span class="o">++</span>
            <span class="k">break</span> <span class="k">if</span> <span class="nx">@offset</span> <span class="o">is</span> <span class="nx">@terminal</span>
            <span class="k">return</span> <span class="nx">offset</span> <span class="o">-</span> <span class="nx">start</span> <span class="k">if</span> <span class="nx">offset</span> <span class="o">is</span> <span class="nx">end</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>Otherwise we're unpacking bytes of an unsigned integer, the most common
case.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">else</span>
          <span class="nx">loop</span>
            <span class="nx">buffer</span><span class="p">[</span><span class="nx">offset</span><span class="p">]</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">@value</span> <span class="err">/ Math.pow(256, @offset)) &amp; 0xff</span>
            <span class="nx">@offset</span> <span class="o">+=</span> <span class="nx">@increment</span>
            <span class="nx">@bytesWritten</span><span class="o">++</span>
            <span class="nx">offset</span><span class="o">++</span>
            <span class="k">break</span> <span class="k">if</span> <span class="nx">@offset</span> <span class="o">is</span> <span class="nx">@terminal</span>
            <span class="k">return</span> <span class="nx">offset</span> <span class="o">-</span> <span class="nx">start</span> <span class="k">if</span> <span class="nx">offset</span> <span class="o">is</span> <span class="nx">end</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>If we have not terminated, check for the termination state change.
Termination will change the loop settings.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">@terminates</span>
        <span class="k">if</span> <span class="nx">@terminated</span>
          <span class="k">if</span> <span class="nx">@repeat</span> <span class="o">is</span> <span class="nb">Number</span><span class="p">.</span><span class="nx">MAX_VALUE</span>
            <span class="vi">@repeat = </span><span class="nx">@index</span> <span class="o">+</span> <span class="mi">1</span>
          <span class="k">else</span> <span class="k">if</span> <span class="nx">@pattern</span><span class="p">[</span><span class="nx">@patternIndex</span><span class="p">].</span><span class="nx">padding</span><span class="o">?</span>
            <span class="vi">@padding = </span><span class="nx">@pattern</span><span class="p">[</span><span class="nx">@patternIndex</span><span class="p">].</span><span class="nx">padding</span>
          <span class="k">else</span>
            <span class="vi">@_skipping = </span><span class="p">(</span><span class="nx">@repeat</span> <span class="o">-</span> <span class="p">(</span><span class="o">++</span><span class="nx">@index</span><span class="p">))</span> <span class="o">*</span> <span class="nx">@pattern</span><span class="p">[</span><span class="nx">@patternIndex</span><span class="p">].</span><span class="nx">bytes</span>
            <span class="k">if</span> <span class="nx">@_skipping</span>
              <span class="vi">@repeat = </span><span class="nx">@index</span> <span class="o">+</span> <span class="mi">1</span>
              <span class="k">continue</span>
        <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>If we are at the end of the series, then we create an empty outgoing
array to hold the terminator, because the outgoing series may be a
buffer. We insert the terminator at next index in the outgoing array.
We then set repeat to allow one more iteration before callback.</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="k">if</span> <span class="nx">@_outgoing</span><span class="p">[</span><span class="nx">@patternIndex</span><span class="p">].</span><span class="nx">length</span> <span class="o">is</span> <span class="nx">@index</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="vi">@terminated = </span><span class="kc">true</span>
            <span class="nx">@_outgoing</span><span class="p">[</span><span class="nx">@patternIndex</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="nx">@_outgoing</span><span class="p">[</span><span class="nx">@patternIndex</span><span class="p">][</span><span class="nx">@index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@pattern</span><span class="p">[</span><span class="nx">@patternIndex</span><span class="p">].</span><span class="nx">terminator</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>If we are reading an arrayed pattern and we have not read all of the
array elements, we repeat the current field type.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="o">++</span><span class="nx">@index</span> <span class="o">&lt;</span> <span class="nx">@repeat</span>
        <span class="nx">@nextValue</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>If we have written all of the packet fields, call the associated
callback with this parser.</p>

<p>The pattern is set to null, our terminal condition, before the callback,
because the callback may specify a subsequent packet to parse.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">else</span> <span class="k">if</span> <span class="o">++</span><span class="nx">@patternIndex</span> <span class="o">is</span> <span class="nx">@pattern</span><span class="p">.</span><span class="nx">length</span>
        <span class="vi">@pattern = </span><span class="kc">null</span>
        <span class="nx">@callback</span><span class="p">.</span><span class="nx">call</span> <span class="nx">@self</span><span class="p">,</span> <span class="k">this</span>

      <span class="k">else</span>

        <span class="k">delete</span>        <span class="nx">@padding</span>
        <span class="vi">@repeat       = </span><span class="nx">@pattern</span><span class="p">[</span><span class="nx">@patternIndex</span><span class="p">].</span><span class="nx">repeat</span>
        <span class="vi">@terminated   = </span><span class="o">not</span> <span class="nx">@pattern</span><span class="p">[</span><span class="nx">@patternIndex</span><span class="p">].</span><span class="nx">terminator</span>
        <span class="vi">@terminates   = </span><span class="o">not</span> <span class="nx">@terminated</span>
        <span class="vi">@index        = </span><span class="mi">0</span>

        <span class="nx">@nextField</span><span class="p">()</span>
        <span class="nx">@nextValue</span><span class="p">()</span>

    <span class="vi">@_outgoing = </span><span class="kc">null</span>

    <span class="nx">offset</span> <span class="o">-</span> <span class="nx">start</span>

<span class="nv">module.exports.Structure = </span><span class="k">class</span> <span class="nx">Structure</span>
  <span class="nv">constructor: </span><span class="nf">(pattern) -&gt;</span>
    <span class="vi">@parser = </span><span class="k">new</span> <span class="nx">Parser</span><span class="p">()</span>
    <span class="nx">@parser</span><span class="p">.</span><span class="nx">packet</span><span class="p">(</span><span class="s2">&quot;structure&quot;</span><span class="p">,</span> <span class="nx">pattern</span><span class="p">)</span>

    <span class="vi">@serializer = </span><span class="k">new</span> <span class="nx">Serializer</span><span class="p">()</span>
    <span class="nx">@serializer</span><span class="p">.</span><span class="nx">packet</span><span class="p">(</span><span class="s2">&quot;structure&quot;</span><span class="p">,</span> <span class="nx">pattern</span><span class="p">)</span>

  <span class="nv">sizeOf: </span><span class="nf">(values...) -&gt;</span> <span class="mi">0</span>

  <span class="nv">read: </span><span class="nf">(buffer, offset, callback) -&gt;</span>
    <span class="nv">callback = </span><span class="nx">offset</span> <span class="k">if</span> <span class="k">typeof</span> <span class="nx">offset</span> <span class="o">is</span> <span class="s2">&quot;function&quot;</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">callback</span>
    <span class="nx">@parser</span><span class="p">.</span><span class="nx">reset</span><span class="p">()</span>
    <span class="nx">@parser</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="s2">&quot;structure&quot;</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span>
    <span class="nx">@parser</span><span class="p">.</span><span class="nx">read</span><span class="p">(</span><span class="nx">buffer</span><span class="p">,</span> <span class="nx">offset</span><span class="p">,</span> <span class="nb">Number</span><span class="p">.</span><span class="nx">MAX_VALUE</span><span class="p">)</span>

  <span class="nv">write: </span><span class="nf">(values...) -&gt;</span>
    <span class="nv">buffer = </span><span class="nx">values</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 